name: KeyVault Role & Secrets Setup

on:
  workflow_dispatch: # puedes ejecutarlo manualmente
  push:
    branches:
      - main

jobs:
  setup-keyvault:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      # =========================================================
      # 1Ô∏è‚É£ Checkout del repositorio
      # =========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      # 2Ô∏è‚É£ Autenticaci√≥n con Service Principal persistente
      # =========================================================
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # =========================================================
      # 3Ô∏è‚É£ Variables base
      # =========================================================
      - name: Define key environment variables
        run: |
          echo "RESOURCE_GROUP=Dojo_Develop" >> $GITHUB_ENV
          echo "LOCATION=${{ secrets.TF_VAR_LOCATION }}" >> $GITHUB_ENV
          echo "KEYVAULT_NAME=${{ secrets.TF_VAR_KEY_VAULT_NAME }}" >> $GITHUB_ENV
          echo "BACKEND_APP=${{ secrets.TF_VAR_APP_SERVICE_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.TF_VAR_SQL_ADMIN_LOGIN }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.TF_VAR_SQL_ADMIN_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.TF_VAR_DATABASE_NAME }}" >> $GITHUB_ENV

      # =========================================================
      # 4Ô∏è‚É£ Obtener identidad administrada del backend
      # =========================================================
      - name: Get backend Managed Identity
        id: mi
        run: |
          principal_id=$(az webapp identity show \
            --name $BACKEND_APP \
            --resource-group $RESOURCE_GROUP \
            --query principalId -o tsv)
          echo "PRINCIPAL_ID=$principal_id" >> $GITHUB_ENV
          echo "üîπ Managed Identity del backend: $principal_id"

      # =========================================================
      # 5Ô∏è‚É£ Asignar roles RBAC al Key Vault
      # =========================================================
      - name: Assign RBAC roles on Key Vault
        run: |
          vault_id=$(az keyvault show --name $KEYVAULT_NAME --query id -o tsv)

          echo "üîπ Asignando permisos Key Vault Secrets User..."
          az role assignment create \
            --assignee $PRINCIPAL_ID \
            --role "Key Vault Secrets User" \
            --scope $vault_id || echo "Rol ya existente o asignado"

          echo "üîπ Asignando permisos Key Vault Secrets Officer..."
          az role assignment create \
            --assignee $PRINCIPAL_ID \
            --role "Key Vault Secrets Officer" \
            --scope $vault_id || echo "Rol ya existente o asignado"

      # =========================================================
      # 6Ô∏è‚É£ Crear secretos cifrados en el Key Vault
      # =========================================================
      - name: Create or update secrets in Key Vault
        run: |
          az keyvault secret set --vault-name $KEYVAULT_NAME --name "db-username" --value "$DB_USER"
          az keyvault secret set --vault-name $KEYVAULT_NAME --name "db-password" --value "$DB_PASSWORD"
          az keyvault secret set --vault-name $KEYVAULT_NAME --name "db-database" --value "$DB_NAME"

      # =========================================================
      # 7Ô∏è‚É£ Configurar variables de entorno del App Service (Key Vault references)
      # =========================================================
      - name: Update App Service configuration
        run: |
          az webapp config appsettings set \
            --name $BACKEND_APP \
            --resource-group $RESOURCE_GROUP \
            --settings \
              DB_USERNAME="@Microsoft.KeyVault(SecretUri=https://${KEYVAULT_NAME}.vault.azure.net/secrets/db-username/)" \
              DB_PASSWORD="@Microsoft.KeyVault(SecretUri=https://${KEYVAULT_NAME}.vault.azure.net/secrets/db-password/)" \
              DB_DATABASE="@Microsoft.KeyVault(SecretUri=https://${KEYVAULT_NAME}.vault.azure.net/secrets/db-database/)"
